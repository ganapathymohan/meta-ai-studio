name: Build Meta AI Studio APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:          # â† lets you trigger manually from GitHub UI

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Debug APK (always runs, no secrets needed)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-debug:
    name: ğŸ”¨ Build Debug APK
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Fix CRLF on gradlew (committed from Windows checkout)
      - name: Fix gradlew line endings
        run: sed -i 's/\r//' gradlew

      # 3. Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Cache Gradle dependencies
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. Bootstrap Gradle wrapper JAR (AFTER cache so cache can't override it)
      - name: Bootstrap Gradle Wrapper JAR and make executable
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          curl -fsSL \
            -H "Accept: application/vnd.github.raw" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/gradle/gradle/contents/gradle/wrapper/gradle-wrapper.jar?ref=v8.4.0" \
            -o gradle/wrapper/gradle-wrapper.jar
          echo "JAR size: $(wc -c < gradle/wrapper/gradle-wrapper.jar) bytes"
          printf "JAR magic bytes: "; xxd -l 4 gradle/wrapper/gradle-wrapper.jar
          # Abort if not a real ZIP/JAR (PK magic = 50 4B 03 04)
          MAGIC=$(xxd -l 2 -p gradle/wrapper/gradle-wrapper.jar)
          if [ "$MAGIC" != "504b" ]; then
            echo "ERROR: gradle-wrapper.jar is not a valid JAR (got hex: $MAGIC)"
            cat gradle/wrapper/gradle-wrapper.jar
            exit 1
          fi
          chmod +x gradlew
          echo "âœ… gradle-wrapper.jar is valid and gradlew is executable"

      # 6. Build Debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      # 7. Upload Debug APK as artifact
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: MetaAIStudio-Debug-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      # 8. Print APK info
      - name: APK Build Info
        run: |
          echo "âœ… Debug APK built successfully!"
          echo "ğŸ“¦ File: app/build/outputs/apk/debug/app-debug.apk"
          ls -lh app/build/outputs/apk/debug/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Signed Release APK (needs keystore secrets)
  # Note: Uses environment-based secret check to avoid GitHub
  #       secret-in-condition evaluation issues.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-release:
    name: ğŸš€ Build Signed Release APK
    runs-on: ubuntu-latest
    needs: build-debug          # Run after debug succeeds

    # Use an environment output check instead of direct secret comparison
    env:
      HAS_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 != '' }}

    steps:
      - name: Check if keystore secret is configured
        id: check_secrets
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸  KEYSTORE_BASE64 secret not set â€” skipping release build."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Keystore secret found â€” proceeding with release build."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check_secrets.outputs.skip == 'false'
        uses: actions/checkout@v4

      - name: Bootstrap Gradle Wrapper JAR
        if: steps.check_secrets.outputs.skip == 'false'
        run: |
          curl -fsSL -o gradle/wrapper/gradle-wrapper.jar \
            "https://raw.githubusercontent.com/gradle/gradle/v8.4.0/gradle/wrapper/gradle-wrapper.jar"

      - name: Set up JDK 17
        if: steps.check_secrets.outputs.skip == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Cache Gradle packages
        if: steps.check_secrets.outputs.skip == 'false'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Fix gradlew line endings and make executable
        if: steps.check_secrets.outputs.skip == 'false'
        run: |
          sed -i 's/\r//' gradlew
          chmod +x gradlew

      # Decode keystore from base64 secret
      - name: Decode Keystore
        if: steps.check_secrets.outputs.skip == 'false'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.jks
          echo "Keystore decoded successfully"

      # Build signed release APK
      - name: Build Signed Release APK
        if: steps.check_secrets.outputs.skip == 'false'
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=${{ github.workspace }}/app/release.jks \
            -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}" \
            --no-daemon --stacktrace

      # Upload Release APK
      - name: Upload Release APK
        if: steps.check_secrets.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: MetaAIStudio-Release-APK
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 90

      # Clean up keystore (always, even on failure)
      - name: Remove keystore
        if: always() && steps.check_secrets.outputs.skip == 'false'
        run: rm -f app/release.jks

      - name: Release APK Build Info
        if: steps.check_secrets.outputs.skip == 'false'
        run: |
          echo "âœ… Signed Release APK built successfully!"
          ls -lh app/build/outputs/apk/release/

      - name: Skipped Notice
        if: steps.check_secrets.outputs.skip == 'true'
        run: |
          echo "â„¹ï¸ Release build skipped â€” no KEYSTORE_BASE64 secret configured."
          echo "   To enable signed release builds, add the following secrets to your repo:"
          echo "   â€¢ KEYSTORE_BASE64    â€” base64-encoded .jks keystore file"
          echo "   â€¢ KEYSTORE_PASSWORD  â€” keystore password"
          echo "   â€¢ KEY_ALIAS          â€” key alias (e.g. 'metaai')"
          echo "   â€¢ KEY_PASSWORD       â€” key password"
